<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orizon Google Maps Scraper</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAwIiBoZWlnaHQ9IjUwMCIgdmlld0JveD0iMCAwIDUwMCA1MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MDAiIGhlaWdodD0iNTAwIiByeD0iMTAwIiBmaWxsPSIjMjcyODYwIi8+CjxjaXJjbGUgY3g9IjI1MCIgY3k9IjI1MCIgcj0iMTUwIiBmaWxsPSIjZjhjODAwIi8+CjxjaXJjbGUgY3g9IjI1MCIgY3k9IjI1MCIgcj0iNzUiIGZpbGw9IiMyNzI4NjAiLz4KPGNpcmNsZSBjeD0iNDIwIiBjeT0iMTMwIiByPSIxNSIgZmlsbD0iI2Y4Yzg0NSIgc3Ryb2tlPSIjZjhjODAwIiBzdHJva2Utd2lkdGg9IjMiLz4KPC9zdmc+">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #272860 0%, #1a1b4b 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f8c800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #e0e0e0;
            font-weight: 300;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: #f8c800;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            border: 2px solid rgba(248, 200, 0, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #f8c800;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(248, 200, 0, 0.3);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #f8c800;
        }

        .start-button {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #f8c800, #ffd700);
            color: #272860;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(248, 200, 0, 0.4);
        }

        .start-button:active {
            transform: translateY(0);
        }

        .start-button:disabled {
            background: #666;
            color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f8c800, #ffd700);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status-text {
            text-align: center;
            font-size: 1.1rem;
            color: #f8c800;
            font-weight: 600;
        }

        .results-section {
            display: none;
            margin-top: 30px;
        }

        .download-button {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(45deg, #f8c800, #ffd700);
            color: #272860;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            margin-right: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(248, 200, 0, 0.3);
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .orizon-accent {
            color: #f8c800;
        }

        /* Data table styles */
        #dataTable th,
        #dataTable td {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
            font-size: 0.9rem;
        }

        #dataTable th {
            background: rgba(248, 200, 0, 0.3);
            font-weight: 600;
            color: #272860;
        }

        #dataTable tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.05);
        }

        #dataTable tbody tr:hover {
            background: rgba(248, 200, 0, 0.1);
        }

        #dataTableContainer {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .main-card {
                padding: 25px;
            }

            #dataTable {
                font-size: 0.8rem;
            }

            #dataTable th,
            #dataTable td {
                padding: 8px;
            }
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar styling */
        .live-extraction-box::-webkit-scrollbar {
            width: 8px;
        }

        .live-extraction-box::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .live-extraction-box::-webkit-scrollbar-thumb {
            background: #f8c800;
            border-radius: 4px;
        }

        .live-extraction-box::-webkit-scrollbar-thumb:hover {
            background: #ffd700;
        }
        
        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 30px;
            gap: 5px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: rgba(248, 200, 0, 0.2);
            color: white;
        }

        .tab-button.active {
            background: #f8c800;
            color: #272860;
            box-shadow: 0 2px 10px rgba(248, 200, 0, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading indicator -->
    <div id="pageLoader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(39, 40, 96, 0.9); color: #f8c800; display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 1.2rem;">
        <div style="text-align: center;">
            <div style="border: 4px solid rgba(248, 200, 0, 0.3); border-top: 4px solid #f8c800; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p>Loading Orizon Google Maps Scraper...</p>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <!-- Orizon Logo SVG -->
            <svg class="logo" width="150" height="60" viewBox="0 0 300 120" xmlns="http://www.w3.org/2000/svg">
                <!-- Main O Shape -->
                <circle cx="60" cy="60" r="45" fill="#f8c800" stroke="none"/>
                <circle cx="60" cy="60" r="22" fill="#272860"/>
                
                <!-- Copyright symbol -->
                <circle cx="220" cy="35" r="8" fill="none" stroke="#f8c800" stroke-width="2"/>
                <text x="220" y="40" text-anchor="middle" fill="#f8c800" font-family="Arial, sans-serif" font-size="10" font-weight="bold">©</text>
                
                <!-- Text "RIZON" -->
                <text x="140" y="75" fill="#f8c800" font-family="Arial, sans-serif" font-size="36" font-weight="bold">RIZON</text>
            </svg>
            <h1 class="title">Multi-Purpose Scraper</h1>
            <p class="subtitle">Extract business data and emails with ease</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('maps')">Google Maps</button>
            <button class="tab-button" onclick="switchTab('email')">Email Scraper</button>
        </div>

        <!-- Google Maps Scraper Tab -->
        <div id="mapsTab" class="tab-content active">

        <div class="main-card">
            <form id="scraperForm">
                <div class="form-group">
                    <label class="form-label" for="search_query">Search Query</label>
                    <input type="text" id="search_query" name="search_query" class="form-input" 
                           placeholder="e.g., restaurants in Cairo, Egypt" required>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="headless" name="headless" class="checkbox" checked>
                    <label for="headless" class="form-label">Run in headless mode (recommended)</label>
                </div>

                <button type="submit" class="start-button" id="startButton">
                    Start Scraping
                </button>
            </form>

            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-text" id="statusText">Initializing...</div>
                
                <!-- Live extraction display -->
                <div id="liveExtractionContainer" style="margin-top: 20px; display: none;">
                    <h4 style="color: #f8c800; margin-bottom: 5px;">📊 Live Data Extraction</h4>
                    <p style="color: #ccc; margin-bottom: 15px; font-size: 0.85rem;">All extracted businesses are displayed here in real-time</p>
                    <div id="liveExtractionBox" style="
                        max-height: 350px; 
                        overflow-y: auto; 
                        background: rgba(0,0,0,0.3); 
                        border-radius: 10px; 
                        padding: 15px; 
                        border: 1px solid rgba(248, 200, 0, 0.3);
                    ">
                        <!-- Live extracted data will appear here -->
                    </div>
                </div>
            </div>

            <div class="results-section" id="resultsSection">
                <h3 style="color: #f8c800; margin-bottom: 15px;">Scraping Complete!</h3>
                <p style="margin-bottom: 20px;" id="resultsText">Your data has been successfully extracted and saved.</p>
                
                <!-- Download buttons -->
                <div style="margin-bottom: 30px;">
                    <a href="#" class="download-button" id="downloadExcel">📊 Download Excel</a>
                    <button class="download-button" id="viewTableBtn" onclick="toggleDataTable()">👁️ View Data Table</button>
                </div>

                <!-- Data table -->
                <div id="dataTableContainer" style="display: none;">
                    <h4 style="color: #f8c800; margin-bottom: 15px;">Extracted Data</h4>
                    <div style="overflow-x: auto; max-height: 400px; background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;">
                        <table id="dataTable" style="width: 100%; border-collapse: collapse; color: white;">
                            <thead style="background: rgba(248, 200, 0, 0.2); position: sticky; top: 0;">
                                <tr id="tableHeader">
                                    <!-- Headers will be populated by JavaScript -->
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- End Google Maps Tab -->

        <!-- Email Scraper Tab -->
        <div id="emailTab" class="tab-content">
            <div class="main-card">
                <form id="emailScraperForm">
                    <div class="form-group">
                        <label class="form-label" for="email_domain">Target Domain</label>
                        <input type="text" id="email_domain" name="email_domain" class="form-input" 
                               placeholder="e.g., example.com" required>
                        <div class="form-help">Enter the domain to search for emails (without www or http)</div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <label class="checkbox-label">
                                <input type="checkbox" id="include_patterns" name="include_patterns" checked>
                                <span class="checkbox-custom"></span>
                                Include pattern-generated emails
                            </label>
                        </div>
                        <div class="form-help">Generate potential emails like info@domain.com, ceo@domain.com, etc.</div>
                    </div>

                    <button type="submit" id="emailStartButton" class="start-btn">
                        <span>🔍</span>
                        Start Email Extraction
                    </button>
                </form>

                <!-- Email Progress Section -->
                <div id="emailProgressSection" class="progress-section" style="display: none;">
                    <h3>Email Extraction Progress</h3>
                    <div class="progress-bar">
                        <div id="emailProgressFill" class="progress-fill"></div>
                    </div>
                    <div id="emailProgressText" class="progress-text">0%</div>
                    <div id="emailStatusText" class="status-text">Ready to start email extraction</div>
                    
                    <!-- Live Email Extraction -->
                    <div id="liveEmailContainer" style="margin-top: 20px; display: none;">
                        <h4>Found Emails:</h4>
                        <div id="liveEmailBox" class="live-extraction-box">
                            <!-- Live emails will appear here -->
                        </div>
                    </div>
                </div>

                <!-- Email Results Section -->
                <div id="emailResultsSection" class="results-section" style="display: none;">
                    <h3>Email Extraction Complete!</h3>
                    <p id="emailResultsText">Successfully extracted email addresses.</p>
                    
                    <div class="results-actions">
                        <a href="#" id="downloadEmailExcel" class="download-btn">
                            <span>📊</span>
                            Download Excel File
                        </a>
                        <button onclick="showEmailDetails()" class="view-btn">
                            <span>👁️</span>
                            View Email Details
                        </button>
                    </div>

                    <!-- Email Data Table -->
                    <div id="emailTableContainer" style="display: none;">
                        <div class="table-container">
                            <table id="emailTable" class="data-table">
                                <thead>
                                    <!-- Headers will be populated by JavaScript -->
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Email Scraper Tab -->

        <div class="footer">
            <p>&copy; 2025 <span class="orizon-accent">Orizon</span>. All rights reserved.</p>
        </div>
    </div>

    <script>
        class GoogleMapsScraper {
            constructor() {
                try {
                    console.log('Initializing GoogleMapsScraper...');
                    this.form = document.getElementById('scraperForm');
                    this.startButton = document.getElementById('startButton');
                    this.progressSection = document.getElementById('progressSection');
                    this.resultsSection = document.getElementById('resultsSection');
                    this.progressFill = document.getElementById('progressFill');
                    this.statusText = document.getElementById('statusText');
                    this.downloadExcel = document.getElementById('downloadExcel');
                    this.extractedData = null;
                    
                    // Check if all elements are found
                    if (!this.form) console.error('Form not found: scraperForm');
                    if (!this.startButton) console.error('Button not found: startButton');
                    if (!this.progressSection) console.error('Section not found: progressSection');
                    if (!this.resultsSection) console.error('Section not found: resultsSection');
                    if (!this.progressFill) console.error('Element not found: progressFill');
                    if (!this.statusText) console.error('Element not found: statusText');
                    if (!this.downloadExcel) console.error('Element not found: downloadExcel');
                    
                    this.init();
                    console.log('GoogleMapsScraper initialized successfully!');
                } catch (error) {
                    console.error('Error initializing GoogleMapsScraper:', error);
                }
            }

            init() {
                try {
                    this.form.addEventListener('submit', this.handleSubmit.bind(this));
                    
                    // Hide the page loader
                    const loader = document.getElementById('pageLoader');
                    if (loader) {
                        loader.style.display = 'none';
                    }
                    
                    console.log('Event listeners attached successfully');
                } catch (error) {
                    console.error('Error in init():', error);
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const formData = new FormData(this.form);
                const data = {
                    search_query: formData.get('search_query'),
                    headless: formData.has('headless')
                };

                this.startScraping(data);
            }

            async startScraping(data) {
                // Disable form and show progress
                this.startButton.disabled = true;
                this.startButton.textContent = 'Scraping...';
                this.progressSection.style.display = 'block';
                this.resultsSection.style.display = 'none';

                try {
                    // Start the scraping process
                    const response = await fetch('/api/scrape', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to start scraping');
                    }

                    // Poll for progress updates
                    this.pollProgress();
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.statusText.textContent = 'Error occurred during scraping';
                    this.statusText.style.color = '#ff6b6b';
                    // Reset button state on error
                    this.startButton.disabled = false;
                    this.startButton.textContent = 'Start Scraping';
                }
            }

            async pollProgress() {
                const checkProgress = async () => {
                    try {
                        const response = await fetch('/api/progress');
                        const progress = await response.json();
                        
                        // Update UI
                        this.statusText.textContent = progress.message;
                        this.progressFill.style.width = `${progress.progress}%`;
                        
                        // Show extraction progress if available
                        if (progress.extracted_count !== undefined && progress.total_locations > 0) {
                            const extractionText = ` (${progress.extracted_count}/${progress.total_locations} extracted)`;
                            this.statusText.textContent = progress.message + extractionText;
                        }
                        
                        // Show live extraction data
                        if (progress.live_messages && progress.live_messages.length > 0) {
                            this.showLiveExtraction(progress.live_messages);
                        }
                        
                        // Check for completion
                        if (progress.status === 'completed') {
                            this.showResults(progress.results);
                            return; // Stop polling
                        } else if (progress.status === 'error') {
                            this.statusText.textContent = progress.message;
                            this.statusText.style.color = '#ff6b6b';
                            // Reset button state on error
                            this.startButton.disabled = false;
                            this.startButton.textContent = 'Start Scraping';
                            return; // Stop polling
                        } else {
                            // Continue polling every 2 seconds
                            setTimeout(checkProgress, 2000);
                        }
                    } catch (error) {
                        console.error('Progress polling error:', error);
                        setTimeout(checkProgress, 5000); // Retry after 5 seconds
                    }
                };
                
                checkProgress();
            }

            showLiveExtraction(liveMessages) {
                const container = document.getElementById('liveExtractionContainer');
                
                // Show the container
                container.style.display = 'block';
                
                // Update the live extraction box to show a table instead of logs
                if (liveMessages.length > 0) {
                    let tableHTML = `
                        <div style="overflow-x: auto; max-height: 300px;">
                            <table style="width: 100%; border-collapse: collapse; color: white; font-size: 0.9rem;">
                                <thead style="background: rgba(248, 200, 0, 0.2); position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">#</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Business Name</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Category</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Phone</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Rating</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Address</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    let businessIndex = 1;
                    liveMessages.forEach((msg, index) => {
                        if (msg.startsWith('EXTRACTED_ROW:')) {
                            const data = msg.substring('EXTRACTED_ROW:'.length);
                            const businessData = this.parseBusinessData(data);
                            
                            const rowClass = businessIndex % 2 === 0 ? 'even-row' : 'odd-row';
                            tableHTML += `
                                <tr class="${rowClass}" style="animation: fadeInSlide 0.5s ease-in; background: ${businessIndex % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'rgba(248,200,0,0.1)'};">
                                    <td style="padding: 8px; border: 1px solid rgba(255,255,255,0.1);">${businessIndex}</td>
                                    <td style="padding: 8px; border: 1px solid rgba(255,255,255,0.1); font-weight: bold; color: #f8c800;">${businessData.name}</td>
                                    <td style="padding: 8px; border: 1px solid rgba(255,255,255,0.1);">${businessData.category}</td>
                                    <td style="padding: 8px; border: 1px solid rgba(255,255,255,0.1);">${businessData.phone}</td>
                                    <td style="padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                        ${businessData.rating !== '[NOT FOUND]' ? '⭐ ' + businessData.rating : businessData.rating}
                                    </td>
                                    <td style="padding: 8px; border: 1px solid rgba(255,255,255,0.1); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${businessData.address}">${businessData.address}</td>
                                </tr>
                            `;
                            businessIndex++;
                        }
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    const box = document.getElementById('liveExtractionBox');
                    box.innerHTML = tableHTML;
                    
                    // Auto-scroll to bottom to show latest entries
                    box.scrollTop = box.scrollHeight;
                } else {
                    // Show empty state message
                    const box = document.getElementById('liveExtractionBox');
                    box.innerHTML = `
                        <div style="text-align: center; color: #888; padding: 40px;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">📊</div>
                            <p>Waiting for businesses to be extracted...</p>
                            <p style="font-size: 0.8rem; opacity: 0.7;">The live table will appear once data extraction begins</p>
                        </div>
                    `;
                }
            }
            
            parseBusinessData(dataString) {
                // Parse the extracted business data from the log format
                const lines = dataString.split('\n').filter(line => line.trim());
                const businessData = {
                    name: '[NOT FOUND]',
                    category: '[NOT FOUND]',
                    phone: '[NOT FOUND]',
                    rating: '[NOT FOUND]',
                    address: '[NOT FOUND]'
                };
                
                lines.forEach(line => {
                    if (line.includes('Extracted data for ')) {
                        businessData.name = line.split('Extracted data for ')[1].replace(':', '').trim();
                    } else if (line.includes('Category:')) {
                        businessData.category = line.split('Category:')[1].trim();
                    } else if (line.includes('Phone:')) {
                        businessData.phone = line.split('Phone:')[1].trim();
                    } else if (line.includes('Rating:')) {
                        businessData.rating = line.split('Rating:')[1].trim();
                    } else if (line.includes('Address:')) {
                        businessData.address = line.split('Address:')[1].trim();
                    }
                });
                
                return businessData;
            }

            showResults(result) {
                this.progressSection.style.display = 'none';
                this.resultsSection.style.display = 'block';
                
                // Reset button state
                this.startButton.disabled = false;
                this.startButton.textContent = 'Start Scraping';
                
                // Update results text
                const resultsText = document.querySelector('#resultsText');
                resultsText.textContent = `Successfully extracted ${result.total_results} business records.`;
                
                // Set download link
                this.downloadExcel.href = result.excel_file;
                
                // Load extracted data for table display
                this.loadExtractedData();
            }

            async loadExtractedData() {
                try {
                    const response = await fetch('/api/data');
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        this.extractedData = data.data;
                        document.getElementById('viewTableBtn').style.display = 'inline-block';
                    }
                } catch (error) {
                    console.error('Error loading extracted data:', error);
                }
            }

            populateDataTable() {
                if (!this.extractedData || this.extractedData.length === 0) {
                    return;
                }

                const tableHeader = document.getElementById('tableHeader');
                const tableBody = document.getElementById('tableBody');
                
                // Clear existing content
                tableHeader.innerHTML = '';
                tableBody.innerHTML = '';
                
                // Get column headers from the first row
                const headers = Object.keys(this.extractedData[0]);
                
                // Create header row
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header.charAt(0).toUpperCase() + header.slice(1).replace(/_/g, ' ');
                    tableHeader.appendChild(th);
                });
                
                // Create data rows
                this.extractedData.forEach(row => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        const value = row[header];
                        
                        // Handle different data types
                        if (header === 'website' && value && value.startsWith('http')) {
                            td.innerHTML = `<a href="${value}" target="_blank" style="color: #f8c800;">${value}</a>`;
                        } else if (header === 'phone' && value) {
                            td.innerHTML = `<a href="tel:${value}" style="color: #f8c800;">${value}</a>`;
                        } else if (header === 'email' && value) {
                            td.innerHTML = `<a href="mailto:${value}" style="color: #f8c800;">${value}</a>`;
                        } else {
                            td.textContent = value || '-';
                        }
                        
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            }
        }

        // Initialize the scrapers when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');
            try {
                // Initialize Google Maps Scraper
                window.scraperInstance = new GoogleMapsScraper();
                console.log('Google Maps scraper instance created successfully');
                
                // Initialize Email Scraper
                window.emailScraper = new EmailScraper();
                console.log('Email scraper instance created successfully');
                
                // Hide page loader
                document.getElementById('pageLoader').style.display = 'none';
                
            } catch (error) {
                console.error('Failed to create scraper instances:', error);
                // Show a user-friendly error message
                document.body.innerHTML = `
                    <div style="padding: 20px; background: #ff6b6b; color: white; text-align: center;">
                        <h2>Loading Error</h2>
                        <p>Failed to initialize the web application. Please refresh the page.</p>
                        <p>Error: ${error.message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 10px; background: white; color: #ff6b6b; border: none; border-radius: 5px; cursor: pointer;">Refresh Page</button>
                    </div>
                `;
            }
        });

        // Toggle data table visibility
        function toggleDataTable() {
            const container = document.getElementById('dataTableContainer');
            const btn = document.getElementById('viewTableBtn');
            
            if (container.style.display === 'none') {
                // Show table
                window.scraperInstance.populateDataTable();
                container.style.display = 'block';
                btn.textContent = 'Hide Data Table';
            } else {
                // Hide table
                container.style.display = 'none';
                btn.textContent = 'View Data Table';
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Email Scraper Class
        class EmailScraper {
            constructor() {
                this.form = document.getElementById('emailScraperForm');
                this.startButton = document.getElementById('emailStartButton');
                this.progressSection = document.getElementById('emailProgressSection');
                this.resultsSection = document.getElementById('emailResultsSection');
                this.progressFill = document.getElementById('emailProgressFill');
                this.progressText = document.getElementById('emailProgressText');
                this.statusText = document.getElementById('emailStatusText');
                this.downloadExcel = document.getElementById('downloadEmailExcel');
                
                this.init();
            }

            init() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            handleSubmit(e) {
                e.preventDefault();
                const formData = new FormData(this.form);
                
                const data = {
                    domain: formData.get('email_domain'),
                    include_patterns: formData.has('include_patterns')
                };

                this.startScraping(data);
            }

            async startScraping(data) {
                // Disable form and show progress
                this.startButton.disabled = true;
                this.startButton.textContent = 'Extracting Emails...';
                this.progressSection.style.display = 'block';
                this.resultsSection.style.display = 'none';

                try {
                    // Start the email scraping process
                    const response = await fetch('/api/email/scrape', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to start email scraping');
                    }

                    // Poll for progress updates
                    this.pollProgress();
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.statusText.textContent = 'Error occurred during email extraction';
                    this.statusText.style.color = '#ff6b6b';
                    // Reset button state on error
                    this.startButton.disabled = false;
                    this.startButton.textContent = 'Start Email Extraction';
                }
            }

            async pollProgress() {
                const checkProgress = async () => {
                    try {
                        const response = await fetch('/api/email/progress');
                        const progress = await response.json();
                        
                        console.log('Email progress update:', progress);
                        
                        // Update UI
                        this.statusText.textContent = progress.message;
                        this.progressFill.style.width = `${progress.progress}%`;
                        this.progressText.textContent = `${progress.progress}%`;
                        
                        // Show live found emails
                        if (progress.found_emails && progress.found_emails.length > 0) {
                            this.showLiveEmails(progress.found_emails);
                        }
                        
                        // Check for completion
                        if (progress.status === 'completed') {
                            this.showEmailResults(progress);
                            return; // Stop polling
                        } else if (progress.status === 'error') {
                            this.statusText.textContent = progress.message;
                            this.statusText.style.color = '#ff6b6b';
                            // Reset button state on error
                            this.startButton.disabled = false;
                            this.startButton.textContent = 'Start Email Extraction';
                            return; // Stop polling
                        } else {
                            // Continue polling every 2 seconds
                            setTimeout(checkProgress, 2000);
                        }
                    } catch (error) {
                        console.error('Email progress polling error:', error);
                        setTimeout(checkProgress, 5000); // Retry after 5 seconds
                    }
                };
                
                checkProgress();
            }

            showLiveEmails(foundEmails) {
                const container = document.getElementById('liveEmailContainer');
                const emailBox = document.getElementById('liveEmailBox');
                
                // Show the container
                container.style.display = 'block';
                
                // Create table HTML for found emails
                if (foundEmails.length > 0) {
                    let tableHTML = `
                        <div style="overflow-x: auto; max-height: 300px;">
                            <table style="width: 100%; border-collapse: collapse; color: white; font-size: 0.9rem;">
                                <thead style="background: rgba(248, 200, 0, 0.2); position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">#</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Email</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Type</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Confidence</th>
                                        <th style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3); text-align: left;">Method</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    foundEmails.forEach((email, index) => {
                        const confidenceColor = email.confidence >= 0.7 ? '#4CAF50' : 
                                              email.confidence >= 0.4 ? '#FFC107' : '#FF9800';
                        
                        tableHTML += `
                            <tr style="border-bottom: 1px solid rgba(248, 200, 0, 0.1);">
                                <td style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3);">${index + 1}</td>
                                <td style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3);">${email.email}</td>
                                <td style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3);">${email.type.charAt(0).toUpperCase() + email.type.slice(1)}</td>
                                <td style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3);">
                                    <span style="color: ${confidenceColor}; font-weight: bold;">${email.confidence}</span>
                                </td>
                                <td style="padding: 8px; border: 1px solid rgba(248, 200, 0, 0.3);">${email.method}</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    emailBox.innerHTML = tableHTML;
                }
            }

            async showEmailResults(progress) {
                this.progressSection.style.display = 'none';
                this.resultsSection.style.display = 'block';
                
                // Reset button state
                this.startButton.disabled = false;
                this.startButton.textContent = 'Start Email Extraction';
                
                // Update results text
                const resultsText = document.querySelector('#emailResultsText');
                const stats = progress.statistics || {};
                const totalFound = stats.total_found || 0;
                
                resultsText.innerHTML = `
                    Successfully extracted <strong>${totalFound}</strong> email addresses for <strong>${progress.current_domain}</strong>.<br>
                    <small>High confidence: ${stats.high_confidence || 0} | Medium: ${stats.medium_confidence || 0} | Low: ${stats.low_confidence || 0}</small>
                `;
                
                // Set download link
                this.downloadExcel.href = '/api/email/download/excel';
                
                // Load extracted email data for table display
                this.loadEmailData();
            }

            async loadEmailData() {
                try {
                    const response = await fetch('/api/email/results');
                    if (!response.ok) {
                        throw new Error('Failed to fetch email results');
                    }
                    
                    const data = await response.json();
                    console.log('Email results loaded:', data);
                    
                    // This will be used when user clicks "View Email Details"
                    this.emailResultsData = data.results || [];
                    
                } catch (error) {
                    console.error('Error loading email data:', error);
                }
            }
        }

        // Function to show email details table
        function showEmailDetails() {
            const container = document.getElementById('emailTableContainer');
            const btn = event.target;
            
            if (container.style.display === 'none') {
                // Show table and populate it
                if (window.emailScraper && window.emailScraper.emailResultsData) {
                    populateEmailTable(window.emailScraper.emailResultsData);
                }
                container.style.display = 'block';
                btn.textContent = 'Hide Email Details';
            } else {
                // Hide table
                container.style.display = 'none';
                btn.textContent = 'View Email Details';
            }
        }

        function populateEmailTable(emailData) {
            const table = document.getElementById('emailTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            if (emailData && emailData.length > 0) {
                // Create headers
                const headers = Object.keys(emailData[0]);
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                
                // Create data rows
                emailData.forEach((email, index) => {
                    const tr = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = email[header];
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            }
        }
    </script>
</body>
</html>